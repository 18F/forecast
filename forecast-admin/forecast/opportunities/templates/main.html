{% extends "layout.html" %}
{% load static from staticfiles %}

{% block content %}

<div id="results">
  <form class="usa-search usa-search-big">
    <div role="search">
      <label for="search" class="usa-sr-only" for="search-field-big">Search opportunities</label>
      <input class="search" id="search-field-big" type="search" name="search" placeholder="Enter keyword">
      <button type="button" id="filter-button" class="usa-search usa-search-submit" data-sort="description naics">
        <span class="usa-search-submit-text">Search</span>
      </button>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="download-spreadsheet"><a href="api/opportunities/?format=csv">Download Spreadsheet</a></span>
    </div>
  </form>


  <div class="usa-grid">
    <div class="usa-width-one-fourth">

      <form id="agency">
        <div class="form-group-dropdown">
          <label for="agency-dropdown">Filter by Agency</label>
          <select name="agency-dropdown" id="agency-dropdown" >
            <option default value="gsa">GSA</option>
            <option value="state">Department of State</option>
            <option value="ed">Department of Education</option>
          </select>

        </div>
      </form>

      <p>
        <br>
      </p>

      <div class="usa-heading-small">(Only for GSA) Filter by:</div>

      {% include 'includes/filters.html' %}

    </div>
    <div class="usa-width-three-fourths">
      <div id="opportunities">
        <div class="pagination-menu">Browse opportunities</div>
        <ul class="paginationTop"></ul>
        <ul class="list">
            {% include 'includes/opportunity.html' %}
        </ul>
        <ul class="paginationBottom"></ul>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script src="{% static 'assets/js/vendor/jquery-1.11.3.min.js' %}"></script>
<script src="{% static 'assets/js/vendor/underscore-min.js' %}"></script>
<script src="{% static 'assets/js/vendor/list.min.js' %}"></script>
<script src="{% static 'assets/js/vendor/list.pagination.min.js' %}"></script>
<script type="text/javascript">
  /**
   *Initializes list.js
   **/
  var paginationTopOptions = {
    name: 'paginationTop',
    paginationClass: 'paginationTop',
    innerWindow: 5,
    outerWinder: 1
  }
  var paginationBottomOptions = {
    name: 'paginationBottom',
    paginationClass: 'paginationBottom',
    innerWindow: 5,
    outerWinder: 1
  }
  var listOptions = {
    valueNames: [
      'award_status',
      'place_of_performance_state',
      'naics',
      'award_amount',
      'estimated_fiscal_year_quarter',
      'description',
      'funding_agency',
      'estimated_fiscal_year',
      'place_of_performance_city',
      'contract_type',
      'office'
    ]
    , page: 25
    , plugins: [
      ListPagination(paginationTopOptions),
      ListPagination(paginationBottomOptions)]

  };
  var listObj = new List('opportunities', listOptions)
  var data = {}
  var queries = {}
  var urlStem = "api/opportunities/?format=csv"

  /**
   *Initializes the More/Fewer Filters
   **/
  $("#award_amount-dropdown").parent().toggle();
  $("#estimated_fiscal_year_quarter-dropdown").parent().toggle();
  $("#more-filters").on('click', function(e){
    $("#more-filters").text("Fewer Filters");
    $("#award_amount-dropdown").parent().toggle();
    $("#estimated_fiscal_year_quarter-dropdown").parent().toggle();
  });

  // A function to check whether an item matches any active filters
  var filterCheck = function (item, queries) {
    shouldReturn = true;
    _.each(_.keys(queries), function (key) {
      if (key === 'description') {
        if (item.values()[key].indexOf(queries[key]) < 0) {
          shouldReturn = false;
          return shouldReturn;
        }
      } else {
        if (item.values()[key] != queries[key]) {
          shouldReturn = false;
          return shouldReturn;
        }
      }
    });
    return shouldReturn;
  }

  /**
   * Load the Data into the Filters
   **/
  _.each(listOptions.valueNames, function (name) {

    // Create an array for each filterable element
    data[name] = [];
    $('.'+name).each( function (index) {
      data[name].push($(this).text());
    })

    // Find unique values and add them as options in dropdowns
    var opt = _.uniq(data[name]);
    $.each(opt, function(key, value) {
      $('#' + name + '-dropdown')
        .append($("<option></option>")
        .attr("value",value)
        .text(value));
    });

    // Add the filtering action to each dropdown
    var dropdown = "#" + name + "-dropdown";
    $(dropdown).change(function (){
      var value = $(dropdown).val();
      urlQuery = "";
      queries = _.omit(queries, name);
      if (value != "all") {
        queries[name] = value;
      }
      _.each(_.keys(queries), function(key) {
        urlQuery += "&"+key+"="+queries[key]
      })
      $(".download-spreadsheet>a").attr("href",urlStem+urlQuery);
      listObj.filter(function(item) {
        return (filterCheck(item, queries));
      });
    });
  });

  $(document).ready(function () {
    // Search within list of opportunities
    $(".search").keyup(function () {
      urlQuery = "";
      if ($(this).val().length > 0) {
        queries.description = $(this).val();
      } else {
        queries = _.omit(queries, "description");
      }
      _.each(_.keys(queries), function(key) {
        urlQuery += "&"+key+"="+queries[key]
      })
      $(".download-spreadsheet>a").attr("href",urlStem+urlQuery);
      listObj.filter(function(item) {
        return (filterCheck(item, queries));
      });
    });

    // Disable search while it doesn't actually query the DB
    $(".search").keypress(function (event) {
      if (event.which == '13') {
        event.preventDefault();
      }
    });
  });

</script>

{% endblock %}
